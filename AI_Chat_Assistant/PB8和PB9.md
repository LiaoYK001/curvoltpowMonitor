<!-- Generated by SpecStory, Markdown v2.0.0 -->

<!-- Visual Studio Code Session a15bfcc2-151e-48b0-8b48-60dc2642274d (2025-11-19 01:21Z) -->

# PB8下降沿触发PB9状态切换与防抖实现 (2025-11-19 01:21Z)

_**User (2025-11-19 01:44Z)**_

现在通过PB8获取无锁开关信息，开关未按下时候PB8一只拉高为高电平；按下后接地形成下降沿然后短暂低电平，松开开关恢复高电平，现在PB8为TIM4-CH3，让它侦测下降沿（按键按下时候）然后使得PB9状态切换（从初始化的低电平到高电平输出，再按下高电平到低电平，再按下低电平到高电平，也就是执行Toggle逻辑对PB9在每次PB8-TIM4-CH3下降沿时候）。同时对PB8的TIM4-CH3添加软件防抖。

---

_**Agent (model copilot/claude-sonnet-4.5)**_

我来帮你实现PB8(TIM4-CH3)检测下降沿触发PB9状态切换,并添加软件防抖功能。

## 1. 首先修改 `tim.c` 文件,启用TIM4输入捕获中断:

````c
/* USER CODE BEGIN TIM4_Init 2 */
// 启动TIM4 CH3输入捕获中断
HAL_TIM_IC_Start_IT(&htim4, TIM_CHANNEL_3);
/* USER CODE END TIM4_Init 2 */
````

## 2. 在 `main.c` 中添加防抖和状态切换逻辑:

````c
/* USER CODE BEGIN PV */
// ...existing code...

// 无锁开关相关变量
volatile uint32_t last_switch_trigger_time = 0;  // 上次触发时间
const uint32_t SWITCH_DEBOUNCE_TIME = 200;       // 防抖时间 200ms

/* USER CODE END PV */
````

## 3. 在 `main.c` 的 `USER CODE BEGIN 2` 部分初始化PB9:

````c
/* USER CODE BEGIN 2 */
// ...existing code...

// 初始化PB9为低电平输出
HAL_GPIO_WritePin(EnableSwitch_GPIO_Port, EnableSwitch_Pin, GPIO_PIN_RESET);

// ...existing code...
/* USER CODE END 2 */
````

## 4. 在 `stm32f1xx_it.c` 中实现中断回调函数:

````c
/* USER CODE BEGIN 0 */
// 外部变量声明
extern volatile uint32_t last_switch_trigger_time;
extern const uint32_t SWITCH_DEBOUNCE_TIME;
/* USER CODE END 0 */

/* USER CODE BEGIN 1 */
/**
 * @brief TIM4输入捕获回调函数
 * @param htim: TIM句柄
 */
void HAL_TIM_IC_CaptureCallback(TIM_HandleTypeDef *htim)
{
  if (htim->Instance == TIM4)
  {
    if (htim->Channel == HAL_TIM_ACTIVE_CHANNEL_3)
    {
      uint32_t current_time = HAL_GetTick();
      
      // 软件防抖: 检查距离上次触发是否超过防抖时间
      if ((current_time - last_switch_trigger_time) >= SWITCH_DEBOUNCE_TIME)
      {
        // 更新触发时间
        last_switch_trigger_time = current_time;
        
        // 切换PB9状态(Toggle)
        HAL_GPIO_TogglePin(EnableSwitch_GPIO_Port, EnableSwitch_Pin);
      }
    }
  }
}
/* USER CODE END 1 */
````

## 5. 确认 `gpio.c` 中PB9配置正确:

根据你提供的代码,PB9(EnableSwitch_Pin)已经配置为推挽输出模式,这是正确的配置,无需修改。

## 功能说明:

1. **下降沿检测**: TIM4-CH3配置为下降沿触发(已在CubeMX中配置为`TIM_ICPOLARITY_FALLING`)
2. **软件防抖**: 使用200ms的防抖时间,防止机械抖动导致误触发
3. **状态切换**: 每次检测到有效下降沿时,PB9执行Toggle操作
4. **初始状态**: PB9初始化为低电平,第一次按下后变为高电平

## 测试建议:

1. 确认PB9连接的设备初始状态应该对应低电平
2. 如果防抖时间不合适,可以调整`SWITCH_DEBOUNCE_TIME`的值
3. 可以通过LED或万用表观察PB9状态变化
4. 如需调试,可在回调函数中添加计数器或LED指示

这样就实现了通过无锁开关控制PB9状态的完整功能。

---

